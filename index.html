<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圣诞快乐</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="star"></div>
        <div class="christmas-tree">
            <div class="tree-body"></div>
            <div class="tree-lights"></div>
            <div class="tree-base"></div>
        </div>
        <div class="snow-container"></div>
        
        <div class="gifts-container"></div>
        <div class="blessing-container"></div>
        
        <audio id="bgMusic" loop>
            <source src="jingle-bells.mp3" type="audio/mp3">
        </audio>
        <button id="musicToggle" class="music-btn"></button>
        
        <audio id="bellSound">
            <source src="bell.mp3" type="audio/mp3">
        </audio>

        <!-- 消息历史区域 -->
        <div class="history-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>历史消息</h3>
                    <div class="modal-actions">
                        <button class="clear-all-btn">清空全部</button>
                        <button class="close-modal">×</button>
                    </div>
                </div>
                <div class="message-history"></div>
            </div>
        </div>
        
        <div class="message-input-container">
            <form class="message-input-wrapper" onsubmit="return false;">
                <input type="text" 
                       id="messageInput" 
                       placeholder="输入你的圣诞祝福..." 
                       maxlength="50"
                       autocomplete="off">
                <button type="button" id="sendMessage">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
                    </svg>
                </button>
            </form>
        </div>
        
        <div class="character-container"></div>
        
        <!-- 添加管理员按钮，放在合适的位置 -->
        <button id="adminClearBtn" class="admin-btn">✨ 净化星愿</button>
    </div>

    <!-- 先加载本地脚本 -->
    <script src="script.js"></script>

    <!-- Firebase 相关代码 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, remove, onValue, get, update } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDLimspjrv6ChQpehQZmO9QVow6CYWB5e0",
            authDomain: "christmas-22699.firebaseapp.com",
            databaseURL: "https://christmas-22699-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "christmas-22699",
            storageBucket: "christmas-22699.firebasestorage.app",
            messagingSenderId: "737437196010",
            appId: "1:737437196010:web:259763725831b81750c193",
            measurementId: "G-1WMZ68LRJT"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        window.database = getDatabase(app);
        const messagesRef = ref(window.database, 'messages');

        // 获取 DOM 元素
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendMessage');
        const messageHistory = document.querySelector('.message-history');

        // 跟踪已处理的消息
        const processedMessages = new Set();

        // 在 Firebase 初始化后，添加一个变量来跟踪已显示的消息
        const displayedMessages = new Set();

        // 添加删除消息的函数
        window.deleteMessage = async (messageKey, senderId) => {
            try {
                if (senderId === sessionUserId) {
                    await remove(ref(window.database, `messages/${messageKey}`));
                    displayedMessages.delete(messageKey); // 从已显示集合中移除
                    return true;
                }
                return false;
            } catch (error) {
                console.error('删除失败:', error);
                return false;
            }
        };

        // 修改消息加载逻辑
        onValue(messagesRef, (snapshot) => {
            // 清空历史记录显示
            messageHistory.innerHTML = '';
            // 保持已处理消息的跟踪
            processedMessages.clear();

            const messages = snapshot.val();
            if (messages) {
                // 按时间戳排序消息
                Object.entries(messages)
                    .map(([key, message]) => ({ key, ...message }))
                    .sort((a, b) => a.timestamp - b.timestamp)
                    .forEach(message => {
                        if (!processedMessages.has(message.key)) {
                            processedMessages.add(message.key);
                            
                            // 添加到历史记录
                            const messageElement = document.createElement('div');
                            messageElement.className = 'message-item';
                            messageElement.textContent = message.text;
                            
                            // 如果是当前用户的消息，添加删除按钮
                            if (message.senderId === sessionUserId) {
                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'delete-message';
                                deleteBtn.innerHTML = '×';
                                deleteBtn.onclick = async () => {
                                    if (confirm('确定要删除这条消息吗？')) {
                                        const success = await window.deleteMessage(message.key, message.senderId);
                                        if (!success) {
                                            alert('删除失败，请重试');
                                        }
                                    }
                                };
                                messageElement.appendChild(deleteBtn);
                            }
                            
                            messageHistory.appendChild(messageElement);

                            // 检查角色是否已存在
                            if (!Character.characters.has(message.senderId)) {
                                Character.create(message.text, message.senderId);
                            } else {
                                // 如果角色已存在且消息未显示过，才更新消息
                                if (!displayedMessages.has(message.key)) {
                                    const character = Character.characters.get(message.senderId);
                                    character.updateMessage(message.text);
                                }
                            }
                            
                            // 将消息标记为已显示
                            displayedMessages.add(message.key);
                        }
                    });
            }
        });

        // 修改发送消息处理
        sendButton.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (text) {
                try {
                    await push(messagesRef, {
                        text,
                        timestamp: Date.now(),
                        senderId: sessionUserId,
                        deleted: false // 添加删除标记
                    });
                    messageInput.value = '';
                } catch (error) {
                    console.error('发送失败:', error);
                }
            }
        });

        // 净化星愿功能
        document.getElementById('adminClearBtn').addEventListener('click', async () => {
            const password = prompt('请输入管理员密码：');
            if (password === 'xr040615') {
                // 显示管理员面板而不是直接清空
                showAdminPanel();
            } else {
                alert('密码错误！');
            }
        });

        // 回车发送
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendButton.click();
            }
        });

        // 清空消息按钮功能
        document.querySelector('.clear-all-btn').addEventListener('click', () => {
            if (confirm('确定要清空所有消息吗？')) {
                messageHistory.innerHTML = '';
            }
        });

        // 关闭历史消息模态框
        document.querySelector('.close-modal').addEventListener('click', () => {
            document.querySelector('.history-modal').style.display = 'none';
        });

        // 添加管理员面板相关函数
        function showAdminPanel() {
            // 创建管理员面板
            const adminPanel = document.createElement('div');
            adminPanel.className = 'admin-panel';
            adminPanel.innerHTML = `
                <div class="admin-panel-content">
                    <div class="admin-panel-header">
                        <h3>管理员面板</h3>
                        <button class="close-admin-panel">×</button>
                    </div>
                    <div class="admin-panel-body">
                        <div class="character-list"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(adminPanel);

            // 加载所有角色信息
            loadCharacterList(adminPanel.querySelector('.character-list'));

            // 关闭面板
            adminPanel.querySelector('.close-admin-panel').onclick = () => {
                adminPanel.remove();
            };
        }

        function loadCharacterList(container) {
            // 从数据库获取所有消息
            const messagesRef = ref(window.database, 'messages');
            get(messagesRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    const characterMessages = {};

                    // 按用户分组消息
                    Object.entries(messages).forEach(([key, message]) => {
                        if (!characterMessages[message.senderId]) {
                            characterMessages[message.senderId] = [];
                        }
                        characterMessages[message.senderId].push({
                            key,
                            ...message
                        });
                    });

                    // 显示每个角色的信息
                    Object.entries(characterMessages).forEach(([userId, messages]) => {
                        const characterDiv = document.createElement('div');
                        characterDiv.className = 'admin-character-item';
                        characterDiv.innerHTML = `
                            <div class="character-info">
                                <span>用户ID: ${userId}</span>
                                <span>消息数量: ${messages.length}</span>
                            </div>
                            <div class="character-actions">
                                <button class="delete-character">删除角色</button>
                                <button class="delete-messages">删除消息</button>
                            </div>
                            <div class="message-list" style="display: none;">
                                ${messages.map(msg => `
                                    <div class="message-item">
                                        <span>${msg.text}</span>
                                        <button class="delete-single-message" data-key="${msg.key}">×</button>
                                    </div>
                                `).join('')}
                            </div>
                        `;

                        // 删除角色按钮
                        characterDiv.querySelector('.delete-character').onclick = async () => {
                            if (confirm(`确定要删除此角色及其所有消息吗？`)) {
                                await Promise.all(messages.map(msg => 
                                    remove(ref(window.database, `messages/${msg.key}`))
                                ));
                                characterDiv.remove();
                            }
                        };

                        // 删除消息按钮
                        characterDiv.querySelector('.delete-messages').onclick = () => {
                            const messageList = characterDiv.querySelector('.message-list');
                            messageList.style.display = messageList.style.display === 'none' ? 'block' : 'none';
                        };

                        // 单条消息删除
                        characterDiv.querySelectorAll('.delete-single-message').forEach(btn => {
                            btn.onclick = async () => {
                                const messageKey = btn.dataset.key;
                                if (confirm('确定要删除这条消息吗？')) {
                                    await remove(ref(window.database, `messages/${messageKey}`));
                                    btn.closest('.message-item').remove();
                                }
                            };
                        });

                        container.appendChild(characterDiv);
                    });
                }
            });
        }
    </script>
</body>
</html> 