<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圣诞快乐</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="menu-bar">
        <span class="logo">圣诞快乐</span>
        <div class="menu-items">
            <button id="musicToggle" class="menu-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18V5l12-2v13"/>
                    <circle cx="6" cy="18" r="3"/>
                    <circle cx="18" cy="16" r="3"/>
                </svg>
                音乐
            </button>
            <a href="share.html" class="menu-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                    <polyline points="16 6 12 2 8 6"/>
                    <line x1="12" y1="2" x2="12" y2="15"/>
                </svg>
                分享
            </a>
            <a href="https://ryexu.tech" target="_blank" class="menu-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
                访问博客
            </a>
            <button id="adminClearBtn" class="menu-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                净化星愿
            </button>
        </div>
    </div>

    <div class="container">
        <div class="star"></div>
        <div class="christmas-tree">
            <div class="tree-body"></div>
            <div class="tree-lights"></div>
            <div class="tree-base"></div>
        </div>
        <div class="snow-container"></div>
        
        <div class="gifts-container"></div>
        <div class="blessing-container"></div>
        
        <audio id="bgMusic" loop>
            <source src="jingle-bells.mp3" type="audio/mp3">
        </audio>
        <button id="musicToggle" class="music-btn"></button>
        
        <audio id="bellSound">
            <source src="bell.mp3" type="audio/mp3">
        </audio>

        <!-- 消息历史区域 -->
        <div class="history-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>历史消息</h3>
                    <div class="modal-actions">
                        <button class="clear-all-btn">清空全部</button>
                        <button class="close-modal">×</button>
                    </div>
                </div>
                <div class="message-history"></div>
            </div>
        </div>
        
        <!-- 添加管理员面板结构 -->
        <div class="admin-panel" style="display: none;">
            <div class="admin-panel-content">
                <div class="admin-panel-header">
                    <h3>管理员面板</h3>
                    <button class="close-admin-panel">×</button>
                </div>
                <div class="admin-messages-container"></div>
            </div>
        </div>

        <div class="message-input-container">
            <form class="message-input-wrapper" onsubmit="return false;">
                <input type="text" 
                       id="messageInput" 
                       placeholder="输入你的圣诞祝福..." 
                       maxlength="50"
                       autocomplete="off">
                <button type="button" id="sendMessage">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
                    </svg>
                </button>
            </form>
        </div>
        
        <div class="character-container"></div>
    </div>

    <!-- 先加载本地脚本 -->
    <script src="script.js"></script>

    <!-- Firebase 相关代码 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, remove, onValue, get, update } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDLimspjrv6ChQpehQZmO9QVow6CYWB5e0",
            authDomain: "christmas-22699.firebaseapp.com",
            databaseURL: "https://christmas-22699-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "christmas-22699",
            storageBucket: "christmas-22699.firebasestorage.app",
            messagingSenderId: "737437196010",
            appId: "1:737437196010:web:259763725831b81750c193",
            measurementId: "G-1WMZ68LRJT"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        window.database = getDatabase(app);
        const messagesRef = ref(window.database, 'messages');

        // 获取 DOM 元素
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendMessage');
        const messageHistory = document.querySelector('.message-history');

        // 跟踪已处理的消息
        const processedMessages = new Set();

        // 在 Firebase 初始化后，添加一个变量来跟踪已显示的消息
        const displayedMessages = new Set();

        // 修改消息删除函数
        window.deleteMessage = async (messageKey, senderId, isAdmin = false) => {
            try {
                if (senderId === sessionUserId || isAdmin) {
                    await remove(ref(window.database, `messages/${messageKey}`));
                    displayedMessages.delete(messageKey);
                    processedMessages.delete(messageKey); // 确保消息能被重新处理
                    
                    // 如果不是管理员操作，显示用户历史记录
                    if (!isAdmin) {
                        showUserHistory(senderId);
                    }
                    return true;
                }
                return false;
            } catch (error) {
                console.error('删除失败:', error);
                return false;
            }
        };

        // 修改显示用户历史记录的函数
        const showUserHistory = (userId) => {
            const historyModal = document.querySelector('.history-modal');
            const messageHistory = document.querySelector('.message-history');
            
            // 添加实时监听
            const updateHistory = (snapshot) => {
                const messages = snapshot.val();
                messageHistory.innerHTML = '';
                
                if (messages) {
                    // 只显示用户自己的消息并按时间排序
                    Object.entries(messages)
                        .map(([key, message]) => ({ key, ...message }))
                        .filter(message => message.senderId === userId)
                        .sort((a, b) => a.timestamp - b.timestamp)
                        .forEach(message => {
                            const messageElement = document.createElement('div');
                            messageElement.className = 'message-item';
                            messageElement.textContent = message.text;
                            
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'delete-message';
                            deleteBtn.innerHTML = '×';
                            deleteBtn.onclick = async () => {
                                if (confirm('确定要删除这条消息吗？')) {
                                    await deleteMessage(message.key, message.senderId, false);
                                }
                            };
                            messageElement.appendChild(deleteBtn);
                            messageHistory.appendChild(messageElement);
                        });
                }
            };

            // 添加消息监听器
            const historyListener = onValue(messagesRef, updateHistory);

            // 显示历史记录面板
            historyModal.style.display = 'flex';

            // 修改关闭按钮事件
            const closeBtn = document.querySelector('.close-modal');
            closeBtn.onclick = () => {
                historyListener(); // 移除监听器
                historyModal.style.display = 'none';
            };

            // 保存当前用户的历史记录监听器引用
            if (window.currentHistoryListener) {
                window.currentHistoryListener(); // 移除之前的监听器
            }
            window.currentHistoryListener = historyListener;
        };

        // 修改消息监听逻辑
        onValue(messagesRef, (snapshot) => {
            const messages = snapshot.val();
            if (messages) {
                // 更新角色消息
                Object.entries(messages)
                    .map(([key, message]) => ({ key, ...message }))
                    .sort((a, b) => a.timestamp - b.timestamp)
                    .forEach(message => {
                        if (!processedMessages.has(message.key)) {
                            processedMessages.add(message.key);
                            
                            // 更新角色消息
                            if (!Character.characters.has(message.senderId)) {
                                Character.create(message.text, message.senderId);
                            } else if (!displayedMessages.has(message.key)) {
                                const character = Character.characters.get(message.senderId);
                                character.updateMessage(message.text);
                            }
                            
                            displayedMessages.add(message.key);
                        }
                    });
            }
        });

        // 修改发送消息处理
        sendButton.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (text) {
                try {
                    await push(messagesRef, {
                        text,
                        timestamp: Date.now(),
                        senderId: sessionUserId,
                        deleted: false // 添加删除标记
                    });
                    messageInput.value = '';
                } catch (error) {
                    console.error('发送失败:', error);
                }
            }
        });

        // 修改管理员清空功能
        document.getElementById('adminClearBtn').addEventListener('click', async () => {
            const password = prompt('请输入管理员密码：');
            if (password === 'xr040615') {
                // 显示管理员面板
                showAdminPanel();
            } else {
                alert('密码错误！');
            }
        });

        // 回车发送
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendButton.click();
            }
        });

        // 清空消息按钮功能
        document.querySelector('.clear-all-btn').addEventListener('click', () => {
            if (confirm('确定要清空所有消息吗？')) {
                messageHistory.innerHTML = '';
            }
        });

        // 关闭历史消息模态框
        document.querySelector('.close-modal').addEventListener('click', () => {
            document.querySelector('.history-modal').style.display = 'none';
        });

        // 修改管理员面板显示函数
        const showAdminPanel = async () => {
            const adminPanel = document.querySelector('.admin-panel');
            const adminContent = document.querySelector('.admin-messages-container');
            
            // 添加实时监听
            const updateAdminPanel = (snapshot) => {
                const messages = snapshot.val();
                if (messages) {
                    // 按用户分组显示消息
                    const messagesByUser = {};
                    Object.entries(messages).forEach(([key, message]) => {
                        if (!messagesByUser[message.senderId]) {
                            messagesByUser[message.senderId] = [];
                        }
                        messagesByUser[message.senderId].push({ key, ...message });
                    });

                    // 清空现有内容
                    adminContent.innerHTML = '';

                    // 添加每个用户的消息
                    Object.entries(messagesByUser).forEach(([userId, userMessages]) => {
                        const userSection = document.createElement('div');
                        userSection.className = 'admin-character-item';
                        
                        const messagesList = userMessages.map(msg => `
                            <div class="message-item">
                                <span>${msg.text}</span>
                                <button class="delete-single-message" onclick="deleteMessage('${msg.key}', '${msg.senderId}', true)">×</button>
                            </div>
                        `).join('');

                        userSection.innerHTML = `
                            <div class="character-info">
                                <span>用户ID: ${userId}</span>
                                <div class="character-actions">
                                    <button class="delete-messages" onclick="deleteUserMessages('${userId}')">删除此用户所有消息</button>
                                </div>
                            </div>
                            <div class="message-list">${messagesList}</div>
                        `;
                        
                        adminContent.appendChild(userSection);
                    });
                } else {
                    adminContent.innerHTML = '<div class="no-messages">暂无消息</div>';
                }
            };

            // 添加消息监听器
            const messagesListener = onValue(messagesRef, updateAdminPanel);

            // 显示面板
            adminPanel.style.display = 'flex';

            // 添加关闭按钮事件
            document.querySelector('.close-admin-panel').onclick = () => {
                // 关闭面板时移除监听器
                messagesListener();
                adminPanel.style.display = 'none';
            };
        };

        // 修改删除用户所有消息的函数
        window.deleteUserMessages = async (userId) => {
            if (confirm(`确定要删除此用户的所有消息吗？`)) {
                const snapshot = await get(messagesRef);
                const messages = snapshot.val();
                if (messages) {
                    const deletePromises = Object.entries(messages)
                        .filter(([_, message]) => message.senderId === userId)
                        .map(async ([key, _]) => {
                            await deleteMessage(key, userId, true);
                        });
                    
                    await Promise.all(deletePromises);
                    
                    // 清理已处理的消息记录
                    processedMessages.clear();
                    displayedMessages.clear();
                }
            }
        };
    </script>
</body>
</html> 