<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圣诞快乐</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="star"></div>
        <div class="christmas-tree">
            <div class="tree-body"></div>
            <div class="tree-lights"></div>
            <div class="tree-base"></div>
        </div>
        <div class="snow-container"></div>
        
        <div class="gifts-container"></div>
        <div class="blessing-container"></div>
        
        <audio id="bgMusic" loop>
            <source src="jingle-bells.mp3" type="audio/mp3">
        </audio>
        <button id="musicToggle" class="music-btn"></button>
        
        <audio id="bellSound">
            <source src="bell.mp3" type="audio/mp3">
        </audio>

        <!-- 消息历史区域 -->
        <div class="history-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>历史消息</h3>
                    <div class="modal-actions">
                        <button class="clear-all-btn">清空全部</button>
                        <button class="close-modal">×</button>
                    </div>
                </div>
                <div class="message-history"></div>
            </div>
        </div>
        
        <div class="message-input-container">
            <form class="message-input-wrapper" onsubmit="return false;">
                <input type="text" 
                       id="messageInput" 
                       placeholder="输入你的圣诞祝福..." 
                       maxlength="50"
                       autocomplete="off">
                <button type="button" id="sendMessage">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
                    </svg>
                </button>
            </form>
        </div>
        
        <div class="character-container"></div>
        
        <!-- 添加管理员按钮，放在合适的位置 -->
        <button id="adminClearBtn" class="admin-btn">✨ 净化星愿</button>
    </div>

    <!-- 先加载本地脚本 -->
    <script src="script.js"></script>

    <!-- Firebase 相关代码 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, remove, onValue, get, set } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDLimspjrv6ChQpehQZmO9QVow6CYWB5e0",
            authDomain: "christmas-22699.firebaseapp.com",
            databaseURL: "https://christmas-22699-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "christmas-22699",
            storageBucket: "christmas-22699.firebasestorage.app",
            messagingSenderId: "737437196010",
            appId: "1:737437196010:web:259763725831b81750c193",
            measurementId: "G-1WMZ68LRJT"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const messagesRef = ref(database, 'messages');

        // 获取 DOM 元素
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendMessage');
        const messageHistory = document.querySelector('.message-history');

        // 跟踪已处理的消息
        const processedMessages = new Set();

        // 加载历史消息
        onValue(messagesRef, (snapshot) => {
            // 清空现有显示
            messageHistory.innerHTML = '';
            Character.characters.clear();
            processedMessages.clear();

            const messages = snapshot.val();
            if (messages) {
                // 按时间戳排序消息
                const sortedMessages = Object.entries(messages)
                    .map(([key, message]) => ({ key, ...message }))
                    .sort((a, b) => a.timestamp - b.timestamp);

                // 显示所有消息
                sortedMessages.forEach(message => {
                    if (!processedMessages.has(message.key)) {
                        processedMessages.add(message.key);
                        
                        // 添加到历史记录
                        const messageElement = document.createElement('div');
                        messageElement.className = 'message-item';
                        messageElement.textContent = message.text;
                        messageHistory.appendChild(messageElement);

                        // 创建或更新角色
                        Character.create(message.text, message.senderId);
                    }
                });
            }
        });

        // 修改发送消息处理
        sendButton.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (text) {
                try {
                    await push(messagesRef, {
                        text,
                        timestamp: Date.now(),
                        senderId: sessionUserId
                    });
                    messageInput.value = '';
                } catch (error) {
                    console.error('发送失败:', error);
                }
            }
        });

        // 净化星愿功能
        document.getElementById('adminClearBtn').addEventListener('click', async () => {
            const password = prompt('请输入管理员密码：');
            if (password === 'xr040615') {
                if (confirm('确定要清空所有消息吗？此操作不可恢复！')) {
                    try {
                        await remove(messagesRef);
                        messageHistory.innerHTML = '';
                        Character.characters.clear();
                        document.querySelector('.character-container').innerHTML = '';
                        processedMessages.clear();
                        alert('所有消息已清空！');
                    } catch (error) {
                        console.error('清空消息失败:', error);
                        alert('清空消息失败，请重试！');
                    }
                }
            } else {
                alert('密码错误！');
            }
        });

        // 回车发送
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendButton.click();
            }
        });

        // 清空消息按钮功能
        document.querySelector('.clear-all-btn').addEventListener('click', () => {
            if (confirm('确定要清空所有消息吗？')) {
                messageHistory.innerHTML = '';
            }
        });

        // 关闭历史消息模态框
        document.querySelector('.close-modal').addEventListener('click', () => {
            document.querySelector('.history-modal').style.display = 'none';
        });
    </script>
</body>
</html> 